---
layout: post
title: Discount Health Dashboard - Part 1 of ??
author: jesse.wolcott
---

I get a lot of bloodwork done. Its weird. I get an extensive panel done at least twice a year that catalogs a whole mess of things from nutrients to hormones to vitamin levels. I have a binder of all my bloodwork, dating back a couple of years. I also have daily weigh-ins for about 12 years, and step counts for roughly the same amount of time. I'd like to try to build a relational database front-end for this, and potential dip my toes into PowerBI to visualize some of the data. The first step to that, of course, is getting a database up and running that houses my data. I'll be using a local docker container for MS SQL, and only using the container on demand, and not expose to the internet (Because otherwise, yes, HIPAA and everything else. Yikes). 

To set up the SQL server, thankfully, Microsoft has graciously developed an MSSQL docker container, which allows us to make use of their free (as in beer) Developer license. I am using Windows, so obviously this will be different in other OS's. I use MS SQL at work, so that is my "comfort zone". After you download and install Docker Desktop, head over to [Docker Hub](https://hub.docker.com/) and register. Check out all the cool stuff that is there! The image we are looking for is [Here](https://hub.docker.com/_/microsoft-mssql-server). You can search inside of Docker Desktop for mssql and the Microsoft image should come up. 

Open up your command prompt / Windows Terminal / Powershell, and execute the following:
```docker run -e ‘ACCEPT_EULA=Y’ -e ‘SA_PASSWORD=YOURPASSWORDHERE’ -p 1433:1433 -d mcr.microsoft.com/mssql/server:latest```

Be sure to change that 'YOURPASSWORDHERE', thats your server admin password for sql. Once you run that, Docker Desktop will whirr to life and create a container for your SQL server. Congrats, we did it!

Next up, we need to install something to manage the SQL server and interact with it. The two most popular options are SQL Server Management Studio (SSMS) and Azure Data Studio (ADS). I'm going to use SSMS because its what I have always used. We can install that, easy-peasy, with our old friend Winget.

```winget install SSMS```

Once that is installed, we can connect to our containerized database by opening up SSMS and connecting like so:
![ssmsconnect](/assets/img/2023/07/ssms-connect.png)

Then we are greeted with our database server, fresh and ready to build. Right-click on the "Databases" folder, and run through the wizard, creating a database. I called mine "healthresults" but you can name yours whatever. Now we need some data! I'm using my Apple Health data as a starting point, since that is where MOST of the data I have lives. 

After exporting all of my data from Apple Health, I made use of a [Python Script](https://github.com/jameno/Simple-Apple-Health-XML-to-CSV) to convert the XML file to a CSV. This CSV has some problems. My "sourceName" came through as ```JesseÃ¢â‚¬â„¢s iPhone```, which I used Excel to find/replace to ```Jesse's iPhone```. Next up, we need to import the data from Apple Health. Right-click on your database (healthresults) and go to "tasks" and "Import flat file". Select your CSV file (generated by that python script up there, the one we just fixed). I left the values as default, and SSMS tried to import it with what it thought the values should be for each column. You may have to adjust a bunch of Data_Type from nvarchar(1) to something like nvarchar(150), or allow nulls on some fields. This may not be ideal for the long-term, but I am going to see how it goes with that for now. When the import succeeds, it will leave you with a table called "apple_health_export_(date)". Right-click and rename that to "apple_health".

The data is structured in an interesting way. Here are a couple of queries you can use to get started. 

This query will return weight and date.
```SQL
SELECT 
	Concat([value],' ',[Unit]) as 'Weight'
	,left([startDate], 10) as 'Date'
FROM [healthresults].[dbo].[apple_health]
Where [type] like 'bodymass'
Order by [startdate]
```

This query will return weight and date with the measurement separate (useful for graphs)
```SQL
SELECT 
	CONVERT(DECIMAL(10,2),[value]) as 'Weight'
	,[unit] as 'Unit'
	,left([startDate], 10) as 'Date'
FROM [healthresults].[dbo].[apple_health]
Where [type] like 'bodymass'
Order by [startdate]
```

That is the basic structure of querying the data directly. Since the whole darn point of this thing was to get useful data out of PowerBI, now that we have some data set up, lets get that process going. Open up your Microsoft Store, and download PowerBI Desktop. When you open it, its going to ask you to sign in, but you don't actually have to do that (just click cancel).

Select "SQL Server" for your source.
![prbiconnect](/assets/img/2023/07/powerbi-sql1.png)
Enter "localhost:1433" for server and "healthresults" for Database. I also chose "Direct Query" so that my source of truth remains in SQL.
![prbiconnect2](/assets/img/2023/07/powerbi-sql2.png)
Select "Database" and enter username as SA and password as whatever you set in the docker launch.
![prbiconnect2](/assets/img/2023/07/powerbi-sql3.png)
Select your "apple_health" table and click "Load".